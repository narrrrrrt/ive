<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Reversi Room</title>
    <style>
      body { font-family: sans-serif; }
      .board { display: grid; grid-template-columns: repeat(8, 40px); grid-gap: 2px; margin: 20px 0; }
      .cell { width: 40px; height: 40px; background: green; display: flex; align-items: center; justify-content: center; cursor: pointer; }
      .disc { width: 30px; height: 30px; border-radius: 50%; }
      .black { background: black; }
      .white { background: white; border: 1px solid #000; }

      /* --- modal --- */
      .modal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        display: none;
        background: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 6px;
        max-width: 300px;
        text-align: center;
      }
      .modal button {
        margin-top: 10px;
        padding: 6px 12px;
      }
    </style>
  </head>
  <body>
    <h1>Reversi Room</h1>
    <a href="#" id="to-lobby">ロビーへ</a>

    <div id="status"></div>
    <div id="board" class="board"></div>

    <!-- modal -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <div id="modal-message"></div>
        <button id="modal-ok">OK</button>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(location.search)
      const roomId = params.get("id")
      const seat = params.get("seat") || "observer"

      let ws = new WebSocket(`wss://${location.host}/${roomId}/ws`)

      // --- token の保存と再利用 ---
      let myToken = null
      const saved = sessionStorage.getItem(`room-${roomId}-token`)
      if (saved) {
        try {
          const parsed = JSON.parse(saved)
          myToken = parsed.token
        } catch {}
      }

      function sendJoin() {
        ws.send(JSON.stringify({ action: "join", seat, token: myToken }))
      }

      ws.onopen = () => {
        sendJoin()
      }

      const boardEl = document.getElementById("board")
      const statusEl = document.getElementById("status")

      function renderBoard(board) {
        boardEl.innerHTML = ""
        for (let y = 0; y < 8; y++) {
          for (let x = 0; x < 8; x++) {
            const cellEl = document.createElement("div")
            cellEl.className = "cell"
            const c = board[y][x]
            if (c === "B" || c === "W") {
              const disc = document.createElement("div")
              disc.className = "disc " + (c === "B" ? "black" : "white")
              cellEl.appendChild(disc)
            } else if (c === "*") {
              cellEl.textContent = "*"
            }
            boardEl.appendChild(cellEl)
          }
        }
      }

      // --- modal helpers ---
      const modal = document.getElementById("modal")
      const modalMsg = document.getElementById("modal-message")
      const modalOk = document.getElementById("modal-ok")

      function showModal(msg) {
        modalMsg.innerHTML = msg
        modal.style.display = "flex"
      }
      function hideModal() {
        modal.style.display = "none"
      }

      modalOk.onclick = () => {
        hideModal()
        sendJoin()  // OK後に再join
      }

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data)
        if (msg.event === "move") {
          const { board, status } = msg.data
          if (board) renderBoard(board)
          if (status) statusEl.textContent = "Status: " + status
        } else if (msg.event === "finish") {
          const { board } = msg.data
          let black = 0, white = 0
          for (let row of board) {
            for (let c of row) {
              if (c === "B") black++
              else if (c === "W") white++
            }
          }
          let result = `黒: ${black}, 白: ${white}<br>`
          if (black > white) result += "黒の勝ち"
          else if (white > black) result += "白の勝ち"
          else result += "引き分け"
          showModal(result)
        } else if (msg.event === "join") {
          // オブザーバーは finish モーダル中に join が来たら閉じる
          if (seat === "observer" && modal.style.display === "flex") {
            hideModal()
          }
          const { board, status } = msg.data
          if (board) renderBoard(board)
          if (status) statusEl.textContent = "Status: " + status
        }
      }
    </script>
  </body>
</html>