<!DOCTYPE html>
<html>
  <head>
    <title>Reversi Room</title>
    <style>
      body { font-family: sans-serif; }
      #board {
        display: grid;
        grid-template-columns: repeat(8, 40px);
        grid-template-rows: repeat(8, 40px);
        gap: 2px;
        margin: 10px 0;
      }
      .cell {
        width: 40px;
        height: 40px;
        background: #0a0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .black {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: black;
      }
      .white {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 1px solid #000;
      }
      pre {
        background: #eee;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>Reversi Room</h1>

    <!-- 盤面 -->
    <div id="board"></div>

    <hr>
    <h2>Debug Messages</h2>
    <pre id="log"></pre>

    <script>
      // --- URL パラメータから roomId と seat を取得 ---
      const params = new URLSearchParams(location.search);
      const roomId = params.get("id") || "1";
      const seat = params.get("seat") || "observer";

      // --- WebSocket 接続 ---
      const ws = new WebSocket(`wss://${location.host}/${roomId}/ws`);

      ws.addEventListener("open", () => {
        ws.send(JSON.stringify({ event: "join", seat }));
      });

      ws.addEventListener("message", (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          log(`[${msg.event}] ${JSON.stringify(msg.data)}`);

          if (msg.event === "join" || msg.event === "move") {
            const { board, status, black, white } = msg.data;
            if (board) renderBoard(board);
          } else if (msg.event === "leave") {
            const { board } = msg.data;
            if (board) renderBoard(board);
          }
        } catch (e) {
          console.error("invalid message:", evt.data);
        }
      });

      // --- 盤面を描画 ---
      function renderBoard(board) {
        const container = document.getElementById("board");
        container.innerHTML = "";
        board.forEach((row, y) => {
          row.split("").forEach((cell, x) => {
            const div = document.createElement("div");
            div.className = "cell";

            if (cell === "B") {
              div.appendChild(document.createElement("div")).className = "black";
            } else if (cell === "W") {
              div.appendChild(document.createElement("div")).className = "white";
            }
            // "-" は空セルとしてクリック可能

            div.onclick = () => {
              ws.send(JSON.stringify({ event: "move", x, y }));
            };

            container.appendChild(div);
          });
        });
      }

      // --- デバッグログ ---
      function log(text) {
        const debug = document.getElementById("log");
        debug.textContent += text + "\n";
        debug.scrollTop = debug.scrollHeight;
      }
    </script>
  </body>
</html>