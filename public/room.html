<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Reversi Room (Minimal Join Debug)</title>
    <style>
      body { font-family: sans-serif; }
      .board { display: grid; grid-template-columns: repeat(8, 40px); grid-gap: 2px; margin: 20px 0; }
      .cell { width: 40px; height: 40px; background: green; display: flex; align-items: center; justify-content: center; }
      .disc { width: 30px; height: 30px; border-radius: 50%; }
      .black { background: black; }
      .white { background: white; border: 1px solid #000; }
      #debug { margin-top: 20px; font-size: 12px; white-space: pre-wrap; background: #f0f0f0; padding: 10px; }
    </style>
  </head>
  <body>
    <h1>Reversi Room (Minimal Join Debug)</h1>
    <div id="status"></div>
    <div id="board" class="board"></div>
    <div id="debug"></div>

    <script>
      const params = new URLSearchParams(location.search)
      const roomId = params.get("id")
      const seat = params.get("seat") || "observer"

      const debugEl = document.getElementById("debug")
      function log(msg) {
        console.log(msg)
        debugEl.textContent += msg + "\n"
      }

      const boardEl = document.getElementById("board")
      const statusEl = document.getElementById("status")

      function renderBoard(board) {
        log("renderBoard called, board=" + JSON.stringify(board))
        boardEl.innerHTML = ""
        for (let y = 0; y < 8; y++) {
          for (let x = 0; x < 8; x++) {
            const cellEl = document.createElement("div")
            cellEl.className = "cell"
            const c = board[y][x]
            if (c === "B" || c === "W") {
              const disc = document.createElement("div")
              disc.className = "disc " + (c === "B" ? "black" : "white")
              cellEl.appendChild(disc)
            }
            boardEl.appendChild(cellEl)
          }
        }
      }

      // --- WebSocket ---
      let ws = new WebSocket(`wss://${location.host}/${roomId}/ws`)

      ws.addEventListener("open", () => {
        log("connected")
        ws.send(JSON.stringify({ action: "join", seat }))
        log("sent join: seat=" + seat)
      })

      ws.addEventListener("message", (ev) => {
        log("raw: " + ev.data)
        let msg
        try {
          msg = JSON.parse(ev.data)
        } catch (e) {
          log("JSON parse error: " + e)
          return
        }
        log("event: " + msg.event)
        if (msg.event === "join" && msg.data && msg.data.board) {
          renderBoard(msg.data.board)
          if (msg.data.status) {
            statusEl.textContent = "Status: " + msg.data.status
          }
        }
        if (msg.event === "move" && msg.data && msg.data.board) {
          renderBoard(msg.data.board)
          if (msg.data.status) {
            statusEl.textContent = "Status: " + msg.data.status
          }
        }
      })
    </script>
  </body>
</html>