<!DOCTYPE html>
<html>
  <head><title>Reversi Room</title></head>
  <body>
    <h1>Reversi Room</h1>
    <pre id="board"></pre>
    <pre id="debug"></pre>

    <script>
      const params = new URLSearchParams(location.search)
      const id = params.get("id")
      const seat = params.get("seat")

      const ws = new WebSocket(`wss://${location.host}/${id}/ws`)

      ws.addEventListener("open", () => {
        console.log("connected", id, seat)
        ws.send(JSON.stringify({ event: "join", seat }))
      })

      ws.addEventListener("message", (evt) => {
        const msg = JSON.parse(evt.data)
        console.log("recv:", msg)

        const debug = document.getElementById("debug")
        debug.textContent += `[${msg.event}] ${JSON.stringify(msg.data)}\n`

        if (msg.event === "state" && seat === "observer") {
          // observer join 時 → 初期盤面を即描画
          drawBoard(msg.data.board)
        }

        if (msg.event === "join" || msg.event === "move" || msg.event === "reset") {
          // 通常 broadcast → 盤面描画
          if (msg.data?.board) {
            drawBoard(msg.data.board)
          }
        }
      })

      function drawBoard(board) {
        const out = board.map(row => row.join(" ")).join("\n")
        document.getElementById("board").textContent = out
      }
    </script>
  </body>
</html>