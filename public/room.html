<!DOCTYPE html>
<html>
  <head>
    <title>Reversi Room</title>
    <style>
      body { font-family: sans-serif; }
      .board { display: grid; grid-template-columns: repeat(8, 40px); grid-gap: 2px; margin: 20px 0; }
      .cell { width: 40px; height: 40px; background: green; display: flex; align-items: center; justify-content: center; cursor: pointer; }
      .disc { width: 30px; height: 30px; border-radius: 50%; }
      .black { background: black; }
      .white { background: white; border: 1px solid #000; }
      pre { background: #f0f0f0; padding: 10px; }
    </style>
  </head>
  <body>
    <h1>Reversi Room</h1>

    <div id="status"></div>
    <div id="board" class="board"></div>

    <hr>
    <h2>Debug Messages</h2>
    <pre id="log"></pre>

    <script>
      const params = new URLSearchParams(location.search)
      const roomId = params.get("id")
      const seat = params.get("seat") || "observer"

      const ws = new WebSocket(`wss://${location.host}/${roomId}/ws`)

      let myToken = null   // ★ join でもらった token
      let myRole = null    // ★ join でもらった role

      // --- UI 更新関数 ---
      function renderBoard(board) {
        const boardEl = document.getElementById("board")
        boardEl.innerHTML = ""
        board.forEach((row, y) => {
          row.split("").forEach((cell, x) => {
            const cellEl = document.createElement("div")
            cellEl.className = "cell"
            if (cell === "B") {
              const d = document.createElement("div")
              d.className = "disc black"
              cellEl.appendChild(d)
            } else if (cell === "W") {
              const d = document.createElement("div")
              d.className = "disc white"
              cellEl.appendChild(d)
            }

            // --- クリックで move 送信 ---
            cellEl.addEventListener("click", () => {
              if (!myToken || myRole === "observer") {
                console.warn("Observer or no token, cannot move")
                return
              }
              ws.send(JSON.stringify({
                event: "move",
                token: myToken,
                x, y
              }))
            })

            boardEl.appendChild(cellEl)
          })
        })
      }

      function renderStatus(status, black, white) {
        const s = document.getElementById("status")
        s.textContent = `Status: ${status}, Black: ${black}, White: ${white}, You: ${myRole || "?"}`
      }

      // --- WebSocket ---
      ws.addEventListener("open", () => {
        ws.send(JSON.stringify({ event: "join", seat }))
      })

      ws.addEventListener("message", (evt) => {
        try {
          const msg = JSON.parse(evt.data)
          console.log("recv:", msg)

          const debug = document.getElementById("log")
          debug.textContent += `[${msg.event}] ${JSON.stringify(msg.data)}\n`

          if (msg.event === "join") {
            if (msg.data.token) {
              myToken = msg.data.token   // ★ 保存
            }
            if (msg.data.role) {
              myRole = msg.data.role     // ★ 保存
            }
            if (msg.data.board) {
              renderBoard(msg.data.board)
            }
            if (msg.data.status) {
              renderStatus(msg.data.status, msg.data.black, msg.data.white)
            }
          } else if (msg.event === "move") {
            const { board, status } = msg.data
            renderBoard(board)
            renderStatus(status, msg.data.black, msg.data.white)
          } else if (msg.event === "leave") {
            const { board, status, black, white } = msg.data
            if (board) {
              renderBoard(board)   // ← 修正ポイント
            }
            renderStatus(status, black, white)
          }
        } catch (e) {
          console.error("invalid message:", evt.data)
        }
      })
    </script>
  </body>
</html>